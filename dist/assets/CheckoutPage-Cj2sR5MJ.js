import{r as s,p as Q,j as e,G as pe,M as me,d as ue,f as ge,u as he,g as fe,b as ye,a as Y,e as J}from"./index-JHV42PaI.js";import{I as k}from"./InputField-DK3m_TmN.js";import{v as re}from"./sanatize-DUDiTChI.js";import"./index-CrZBkDei.js";import"./eye-CmzZc3tr.js";const be=()=>e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",backgroundColor:"#f0f2f5"},children:[e.jsx("style",{children:`
        .map-spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          width: 36px;
          height: 36px;
          border-radius: 50%;
          border-left-color: #09f;
          animation: spin 1s ease infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}),e.jsx("div",{className:"map-spinner"})]}),xe=({onLocationChange:p,onAddressSelect:t,initialCenter:m,onGeocodingStart:o,onGeocodingEnd:l})=>{const{isLoaded:v}=Q(),I={width:"100%",height:"256px",borderRadius:"0.5rem"},[r,y]=s.useState({center:m,markerPosition:m}),x=s.useRef(null),F=s.useRef(null);s.useEffect(()=>{console.log("ðŸ“ MapSection - initialCenter received:",m),y({center:m,markerPosition:m}),x.current&&setTimeout(()=>{window.google&&window.google.maps&&x.current&&x.current.panTo(m)},100)},[m]);const i=s.useCallback(async(d,n)=>{if(!v||!window.google||!window.google.maps){console.error("Google Maps API not loaded"),t==null||t({address:"",city:"",state:"",pincode:"",country:"India"});return}const N=new window.google.maps.Geocoder,T={lat:d,lng:n};try{o==null||o();const S=await N.geocode({location:T});if(S.results[0]){const B=S.results[0],K=B.address_components,g=h=>{var j;return((j=K.find(w=>w.types.includes(h)))==null?void 0:j.long_name)||""},G={address:B.formatted_address,city:g("locality")||g("administrative_area_level_2")||"",state:g("administrative_area_level_1")||"",pincode:g("postal_code")||"",country:g("country")||"India"};console.log("ðŸ“ Fetched address:",G),t==null||t(G)}else console.warn("No address found for coordinates:",T),t==null||t({address:"",city:"",state:"",pincode:"",country:"India"})}catch(S){console.error("Geocoding error:",S),t==null||t({address:"",city:"",state:"",pincode:"",country:"India"})}finally{l==null||l()}},[v,t,o,l]),E=s.useCallback(d=>{if(!d.latLng){console.error("No coordinates found in marker drag event");return}const n={lat:d.latLng.lat(),lng:d.latLng.lng()};console.log("ðŸ“ Marker dragged to:",n),y(N=>({...N,center:n,markerPosition:n})),p==null||p(n),i(n.lat,n.lng)},[p,i]),b=s.useCallback(d=>{if(!d.latLng){console.error("No coordinates found in map click event");return}const n={lat:d.latLng.lat(),lng:d.latLng.lng()};console.log("ðŸ“ Map clicked at:",n),y(N=>({...N,center:n,markerPosition:n})),p==null||p(n),i(n.lat,n.lng)},[p,i]),C=s.useCallback(d=>{console.log("ðŸ“ Map loaded successfully"),x.current=d},[]),z=s.useCallback(d=>{console.log("ðŸ“ Marker loaded successfully"),F.current=d,setTimeout(()=>{if(d){const n=document.querySelector('[src*="mapfiles/ms/icons/red-dot.png"]');n&&(n.style.zIndex="9999",n.style.position="relative")}},100)},[]);return v?(console.log("ðŸ“ Rendering map with center:",r.center),console.log("ðŸ“ Rendering marker at:",r.markerPosition),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("style",{children:`
          .marker-fix {
            z-index: 9999 !important;
            visibility: visible !important;
            opacity: 1 !important;
          }
          img[src*="red-dot.png"] {
            z-index: 9999 !important;
            visibility: visible !important;
            opacity: 1 !important;
          }
        `}),e.jsx(pe,{mapContainerStyle:I,center:r.center,zoom:15,options:{disableDefaultUI:!0,zoomControl:!0,gestureHandling:"greedy"},onClick:b,onLoad:C,children:r.markerPosition&&e.jsx(me,{position:r.markerPosition,draggable:!0,onDragEnd:E,onLoad:z},`marker-${r.markerPosition.lat}-${r.markerPosition.lng}`)})]})):e.jsx(be,{})},ae=s.memo(xe),se=({label:p,value:t,onChange:m,onPlaceSelect:o,error:l,placeholder:v})=>{const{isLoaded:I}=Q(),r=s.useRef(null),y=s.useRef(null);return s.useEffect(()=>{I&&window.google&&!y.current&&(y.current=new window.google.maps.places.Autocomplete(r.current,{componentRestrictions:{country:"in"},fields:["address_components","formatted_address","geometry"]}),y.current.addListener("place_changed",()=>{const x=y.current.getPlace();if(x.formatted_address){const F={target:{name:"street",value:x.formatted_address}};m(F)}o&&o(x)}))},[I,o,m]),e.jsx(k,{id:"address-autocomplete",name:"street",label:p,value:t,onChange:m,error:l,placeholder:v,ref:r})},je=()=>{const[p,t]=s.useState(!1),[m,o]=s.useState(null);return s.useEffect(()=>{if(document.getElementById("razorpay-script")){t(!0);return}const l=document.createElement("script");return l.src="https://checkout.razorpay.com/v1/checkout.js",l.id="razorpay-script",l.async=!0,l.onload=()=>{t(!0),o(null)},l.onerror=()=>{console.error("Failed to load Razorpay SDK"),o("Failed to load Razorpay SDK"),t(!1)},document.body.appendChild(l),()=>{document.body.contains(l)&&document.body.removeChild(l)}},[]),{isLoaded:p,error:m}},ze=()=>{const{cartItems:p,totalAmount:t,clearCart:m}=ue(),{user:o,token:l}=ge(),v=he(),I=fe(),{t:r}=ye();Q();const{isLoaded:y,error:x}=je(),F={lat:17.385,lng:78.4867},[i,E]=s.useState({name:o?`${(o==null?void 0:o.first_name)||""} ${(o==null?void 0:o.last_name)||""}`.trim():"",phone:(o==null?void 0:o.phone)||"",street:"",city:"",state:"",country:"India",pincode:""}),[b,C]=s.useState({name:"",phone:"",street:"",city:"",state:"",country:"India",pincode:""}),[z,d]=s.useState(F),[n,N]=s.useState(F),[T,S]=s.useState(!1),[B,K]=s.useState(!1),[g,G]=s.useState(!0),[h,j]=s.useState({}),[w,V]=s.useState("cod"),[A,U]=s.useState(!1);s.useEffect(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(a=>{const{latitude:c,longitude:_}=a.coords,P={lat:c,lng:_};d(P),g&&N(P)},()=>console.warn("Geolocation failed. Using default location."))},[g]),s.useEffect(()=>{g&&(C({...i}),N({...z}))},[i,z,g]),s.useEffect(()=>{x&&j(a=>({...a,api:r("Failed to load Razorpay SDK. Please try again later.")}))},[x,r]);const te=()=>{const a={};i.name.trim()||(a.shipping_name=r("Fullname is required"));const c=re(i.phone,!1);if(c&&(a.shipping_phone=c),i.street.trim()||(a.shipping_address=r("Address is required")),i.city.trim()||(a.shipping_city=r("City is required")),/^\d{6}$/.test(i.pincode)||(a.shipping_pincode=r("Invalid pincode")),!g){b.name.trim()||(a.billing_name=r("Full name is required"));const _=re(b.phone,!1);_&&(a.billing_phone=_),b.street.trim()||(a.billing_address=r("Address required")),b.city.trim()||(a.billing_city=r("City is required")),/^\d{6}$/.test(b.pincode)||(a.billing_pincode=r("Invalid pincode"))}return j(a),Object.keys(a).length===0},X=(a,c)=>{if(!a.geometry)return;const _=a.geometry.location,P={lat:_.lat(),lng:_.lng()},u=a.address_components,f=R=>{var M;return((M=u.find(W=>W.types.includes(R)))==null?void 0:M.long_name)||""},L={street:a.formatted_address,city:f("locality")||f("administrative_area_level_2")||"",state:f("administrative_area_level_1")||"",pincode:f("postal_code")||"",country:f("country")||"India"};c==="shipping"?(E(R=>({...R,...L})),d(P)):(C(R=>({...R,...L})),N(P))},O=a=>E(c=>({...c,[a.target.name]:a.target.value})),D=a=>C(c=>({...c,[a.target.name]:a.target.value})),oe=a=>{G(a.target.checked),a.target.checked&&(C({...i}),N({...z}))},H=a=>({firstName:a.name.split(" ")[0]||"",lastName:a.name.split(" ").slice(1).join(" ")||"",addressLine1:a.street,city:a.city,state:a.state,postalCode:a.pincode,country:a.country,phone:a.phone}),ne=async a=>{var P;if(a.preventDefault(),j({}),!o||!l){j({api:r("Please login to continue")}),v("/signin",{state:{from:I}});return}if(!te())return;if(p.length===0)return j({api:r("Your cart is empty")});if(w==="razorpay"&&!y)return j({api:r("Razorpay SDK not loaded. Please try again later.")});U(!0);const c={"Content-Type":"application/json",Authorization:`Bearer ${l}`},_={items:p.map(u=>({product_id:u.id,quantity:u.quantity,store_id:u.store_id})),shipping_address:H(i),billing_address:H(g?i:b),paymentMethod:w};try{const u=await Y(J.orders,{method:"POST",body:_,headers:c});if(!(u!=null&&u.success)||!((P=u.orders)!=null&&P.length))throw new Error(u.message||r("Order creation failed"));const f=u.orders,L=f[0].id;if(w==="razorpay"){const R=Math.round((t+t*.18+50)*100),M=await Y(`${J.createRazorpayOrder}/${L}`,{method:"POST",headers:c,body:{amount:R,currency:"INR"}});if(!M.success)throw new Error(M.message||r("Razorpay order creation failed"));const{razorpayOrderId:W,amount:ie,currency:le}=M.data,Z="rzp_test_RLoyIDyWkucq2a",de={key:Z,amount:ie,currency:le,name:"Shopzeo",description:`Order #${f[0].orderNumber}`,order_id:W,handler:async q=>{try{const $=await Y(`${J.verifyRazorpayPayment}/${L}`,{method:"POST",body:{razorpay_payment_id:q.razorpay_payment_id,razorpay_order_id:q.razorpay_order_id,razorpay_signature:q.razorpay_signature},headers:c});if($.success)m(),v(`/track-order/${f[0].orderNumber}`,{state:{order:f[0]}});else throw new Error($.message||r("Payment verification failed"))}catch($){j(ce=>({...ce,api:`Payment verification failed: ${$.message}`}))}finally{U(!1)}},prefill:{name:i.name,email:o.email,contact:i.phone},theme:{color:"#3399cc"},notes:{order_id:L}},ee=new window.Razorpay(de);ee.on("payment.failed",q=>{j($=>({...$,api:`Payment failed: ${q.error.description||"Unknown error"}`})),U(!1)}),ee.open()}else m(),v(`/order-success/${f[0].orderNumber}`,{state:{order:f[0]}})}catch(u){console.error("Order creation error:",u),j(f=>({...f,api:`Order creation failed: ${u.message}`})),U(!1)}};return e.jsx("div",{className:"container mx-auto px-4 py-8 max-w-7xl",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 border-b pb-3",children:r("Shipping address")}),e.jsxs("div",{className:"space-y-5",children:[e.jsx(k,{id:"shipping-name",name:"name",placeholder:r("Full name"),value:i.name,onChange:O,error:h.shipping_name,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx(k,{id:"shipping-phone",name:"phone",label:r("Phone Number"),placeholder:r("Phone number"),type:"tel",value:i.phone,onChange:O,error:h.shipping_phone,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx(se,{label:r("Full Address"),value:i.street,onChange:O,onPlaceSelect:a=>X(a,"shipping"),error:h.shipping_address,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 items-start",children:[e.jsx(k,{id:"shipping-city",name:"city",label:r("City"),placeholder:r("city"),value:i.city,onChange:O,error:h.shipping_city,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx(k,{id:"shipping-pincode",name:"pincode",label:r("Postal code"),placeholder:r("Postal code"),value:i.pincode,onChange:O,error:h.shipping_pincode,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-700 pt-3 flex items-center gap-2",children:[r("Confirm Shipping Location")," ",T&&e.jsxs("span",{className:"text-sm text-gray-500",children:["(",r("fetching_address"),"...)"]})]}),e.jsx("div",{className:"h-64 w-full rounded-md overflow-hidden",children:e.jsx(ae,{initialCenter:z,onLocationChange:d,onAddressSelect:a=>E(c=>({...c,street:a.address})),onGeocodingStart:()=>S(!0),onGeocodingEnd:()=>S(!1),className:"w-full h-full"},`shipping-${z.lat}-${z.lng}`)})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 border-b pb-3",children:r("Billing address")}),e.jsxs("div",{className:"flex items-center mt-4 mb-3",children:[e.jsx("input",{type:"checkbox",id:"sameAsShipping",checked:g,onChange:oe,className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("label",{htmlFor:"sameAsShipping",className:"ml-2 text-sm text-gray-700",children:r("Same as shipping")})]}),!g&&e.jsxs("div",{className:"space-y-5",children:[e.jsx(k,{id:"billing-name",name:"name",placeholder:r("Full name"),value:b.name,onChange:D,error:h.billing_name,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx(k,{id:"billing-phone",name:"phone",placeholder:r("Phone number"),type:"tel",value:b.phone,onChange:D,error:h.billing_phone,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx(se,{label:r("Full Address"),value:b.street,onChange:D,onPlaceSelect:a=>X(a,"billing"),error:h.billing_address,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 items-start",children:[e.jsx(k,{id:"billing-city",name:"city",label:r("City"),placeholder:r("city"),value:b.city,onChange:D,error:h.billing_city,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx(k,{id:"billing-pincode",name:"pincode",label:r("Postal code"),placeholder:r("Postal code"),value:b.pincode,onChange:D,error:h.billing_pincode,className:"w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-700 pt-3 flex items-center gap-2",children:[r("Confirm Billing Location")," ",B&&e.jsxs("span",{className:"text-sm text-gray-500",children:["(",r("fetching_address"),"...)"]})]}),e.jsx("div",{className:"h-64 w-full rounded-md overflow-hidden",children:e.jsx(ae,{initialCenter:n,onLocationChange:N,onAddressSelect:a=>C(c=>({...c,street:a.address})),onGeocodingStart:()=>K(!0),onGeocodingEnd:()=>K(!1),className:"w-full h-full"},`billing-${n.lat}-${n.lng}`)})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 border-b pb-3",children:r("Payment Method")}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"paymentMethod",value:"cod",checked:w==="cod",onChange:()=>V("cod"),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"ml-3 text-gray-700",children:r("cod")})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"paymentMethod",value:"razorpay",checked:w==="razorpay",onChange:()=>V("razorpay"),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"ml-3 text-gray-700",children:"Razorpay"})]}),!y&&w==="razorpay"&&e.jsxs("p",{className:"text-yellow-600 text-sm mt-1 flex items-center gap-2",children:[e.jsx("span",{className:"animate-pulse",children:"â³"})," ",r("Razorpay SDK is loading...")]}),x&&w==="razorpay"&&e.jsxs("p",{className:"text-red-500 text-sm mt-1 flex items-center gap-2",children:[e.jsx("span",{children:"âš ï¸"})," ",r("Razorpay SDK failed to load. Please try again or use COD.")]})]})]}),h.api&&e.jsx("p",{className:"text-red-500 text-sm mt-4 bg-red-50 p-2 rounded-md",children:h.api}),e.jsx("button",{type:"submit",disabled:A||w==="razorpay"&&!y,onClick:ne,className:`w-full mt-6 py-3 rounded-lg text-white font-semibold transition-all duration-200 ${A||w==="razorpay"&&!y?"bg-gray-400 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 shadow-md"}`,children:A?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"}),r("Placing Order...")]}):r("Place order")})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 border-b pb-3",children:r("order_summary")}),e.jsxs("div",{className:"space-y-4 mt-4",children:[p.map(a=>e.jsxs("div",{className:"flex justify-between items-center py-3 border-b",children:[e.jsxs("span",{className:"text-gray-700",children:[a.name," Ã— ",a.quantity]}),e.jsxs("span",{className:"font-medium text-gray-900",children:["â‚¹",((a.selling_price||a.price||0)*(a.quantity||1)).toFixed(2)]})]},a.id)),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:r("subtotal")}),e.jsxs("span",{className:"text-gray-900",children:["â‚¹",(t||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Tax (18%)"}),e.jsxs("span",{className:"text-gray-900",children:["â‚¹",(t*.18).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:r("shipping")}),e.jsxs("span",{className:"text-gray-900",children:["â‚¹",50 .toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-6 border-t pt-4",children:[e.jsx("span",{className:"text-xl font-bold text-gray-800",children:r("Total")}),e.jsxs("span",{className:"text-xl font-bold text-blue-600",children:["â‚¹",(t+t*.18+50).toFixed(2)]})]})]})]})]})})};export{ze as default};
